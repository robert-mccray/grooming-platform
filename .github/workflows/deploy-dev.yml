name: Deploy Dev (Bicep)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Show Bicep files used by pipeline
        run: |
          echo "=== main.bicep ==="
          sed -n '1,200p' infra/bicep/main.bicep
          echo ""
          echo "=== sql.bicep ==="
          sed -n '1,200p' infra/bicep/modules/sql.bicep

      - name: Deploy Bicep to rg-groom-dev
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          resourceGroupName: rg-groom-dev
          template: infra/bicep/main.bicep
          parameters: >
            infra/env/dev.parameters.json
            sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
          failOnStdErr: false

      - name: Show deployment outputs
        if: always()
        uses: azure/cli@v2
        with:
          inlineScript: |
            az deployment group show -g rg-groom-dev -n main --query "properties.outputs" -o jsonc || true

      - name: Show deployment outputs
        uses: azure/cli@v2
        with:
          inlineScript: |
            az deployment group show -g rg-groom-dev -n main --query "properties.outputs" -o jsonc


      - name: Assign RBAC (ADF MI -> Storage Blob Data Contributor)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -e
            RG="rg-groom-dev"

            # Get the ADF created in this RG
            ADF_NAME=$(az datafactory list -g "$RG" --query "[0].name" -o tsv)
            if [ -z "$ADF_NAME" ]; then
              echo "ERROR: No Data Factory found in $RG"
              exit 1
            fi

            # Get the Storage Account created in this RG
            SA_NAME=$(az storage account list -g "$RG" --query "[0].name" -o tsv)
            if [ -z "$SA_NAME" ]; then
              echo "ERROR: No Storage Account found in $RG"
              exit 1
            fi

            echo "ADF_NAME=$ADF_NAME"
            echo "SA_NAME=$SA_NAME"

            # ADF Managed Identity principalId
            ADF_PRINCIPAL_ID=$(az datafactory show -g "$RG" -n "$ADF_NAME" --query "identity.principalId" -o tsv)
            if [ -z "$ADF_PRINCIPAL_ID" ]; then
              echo "ERROR: Could not resolve ADF principalId (is system identity enabled?)"
              exit 1
            fi

            # Storage scope
            SA_ID=$(az storage account show -g "$RG" -n "$SA_NAME" --query "id" -o tsv)

            echo "ADF_PRINCIPAL_ID=$ADF_PRINCIPAL_ID"
            echo "SA_ID=$SA_ID"

            # Create role assignment (idempotent-ish)
            az role assignment create \
              --assignee-object-id "$ADF_PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role "Storage Blob Data Contributor" \
              --scope "$SA_ID" \
              --only-show-errors || true

            echo "RBAC assignment step complete."
